{% extends "layout.html" %}
{% load static %}
{% block link %}
    {#        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">#}

      <link rel="stylesheet" href="{% static 'css/font-awesome.min.css' %}">

{% endblock %}

{% block css %}

    .container.my-5 {
    max-width: 80vw;
    width: 100%;
    background-color: #fdfdfd; /* 或者 #f8f9fa，比纯白柔和 */
    padding: 4rem 2rem;
    border-radius: 0.75rem;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
    transition: background-color 0.3s ease;
    }
    :root {
    --primary-blue: #007bff;
    --primary-blue-hover: #0056b3;
    --text-dark: #212529;
    --text-light: #6c757d;
    --bg-light: #f8f9fa;
    --border-color: #dee2e6;
    }
    body {
    background-color: #fff;
    color: var(--text-dark);
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    h1 {
    text-align: center;
    margin-bottom: 4vh;
    font-size: 2.5vw;
    }

    .chart-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(42vw, 1fr));
    gap: 2rem;

    }
    .chart-container {
    background: #ffffff;
    padding: 2rem;
    border-radius: 0.75rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    border: 1px solid #e0e0e0;
    transition: transform 0.2s ease;
    {#    aspect-ratio: 4 / 3;#}
    {#    max-height: 80vh;       /* ✅ 限制最大高度 */#}
    min-height: 100px;      /* ✅ 防止过小 */
    overflow: visible;
    display: flex;
    flex-direction: column;
    }
    .section-title .fa {
    color: var(--primary-blue);
    margin-right: 10px;
    }


    .chart-container:hover {
    transform: translateY(-0.25rem);
    }

    .chart-title {
    font-weight: bold;
    font-size: 1.6rem;
    margin-bottom: 1.3rem;
    text-align: center;
    color: #333;
    }
    .section-title {
    background-color: rgba(0, 123, 255, 0.2); /* 加一点淡蓝底 */
    padding: 0.75rem 1rem;
    border-radius: 0.25rem;
    color: var(--text-dark);
    font-weight: 600;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    user-select: none;
    }
    .echart {
    flex-grow: 1;
    width: 100%;
    height: 100%;  /* ✅ 必须是 100%，不能是固定 vh 或 px */
    min-height: 430px;
    }


{% endblock %}

{% block content %}
    <div style="background-color: #f1f3f5; padding: 2rem 0;">
        {#    <h1>DNA Codec Decode Time Dashboard</h1>#}

        <div class="container my-5">
            <h1 class="text-center" data-aos="fade-up" style="font-size: 3vw;font-family: Arial;color: #007bff!important;">
                DNA Evaluate Module
            </h1>
            <!-- 上传 CSV 文件 -->
            <div class="mb-5">

                <h5 class="section-title mb-3"><i class="fa fa-upload"></i>CSV Upload</h5>



                <div class="p-4 border rounded" style="background-color: #fdfdfd;">
                    <!-- 上传 CSV 文件表单 -->
                    <form id="csvUploadForm" enctype="multipart/form-data" method="post" class="row g-3">
                        {% csrf_token %}
                        <div class="col-md-8">
                            <label for="csv_files" class="form-label">Select CSV Files</label>
                            <input type="file"
                                   name="csv_files"
                                   id="csv_files"
                                   class="form-control"
                                   accept=".csv"
                                   multiple
                            >
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="w-100 d-grid gap-2">
                                <button type="button" id="btnAddMore" class="btn btn-outline-secondary">
                                    <i class="fa fa-plus me-1"></i> Add Files
                                </button>
                                <button type="button" id="btnClearAll" class="btn btn-outline-danger">
                                    <i class="fa fa-trash me-1"></i> Clear All
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa fa-upload me-1"></i> Generate Charts
                                </button>
                            </div>
                        </div>

                        <!-- 用于“追加选择”的隐藏文件输入，不显示在界面上 -->
                        <input type="file" id="csv_files_more" accept=".csv" multiple style="display:none">

                    </form>

                </div>
            </div>
            <!-- 放在上传表单块的下面 -->
            <div class="mb-4">
                <h5 class="section-title mb-3">
                    <i class="fa fa-eye"></i> Preview (first 30 rows)
                </h5>

                <div id="previewArea" class="p-3 border rounded" style="background:#fff;">
                    <div class="text-muted">Please select at least one CSV file.</div>
                </div>
            </div>


            <div class="chart-grid" style="display:flex; justify-content:center;">
                <div class="chart-container" style="width:100%; max-width:1000px;">
                    <div class="chart-title">

                    </div>
                    <div id="radarChart" class="echart"></div>
                </div>
            </div>

        </div>

    </div>

{% endblock %}

{% block script %}

    {#    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>#}
    <script src="{% static 'js/papaparse.min.js' %}"></script>
    <script src="{% static 'js/bootstrap-5.3.3.bundle.min.js' %}"></script>
    <script src="{% static 'js/jquery-3.5.1.min.js' %}"></script>
    <script src="{% static 'js/echarts@5' %}"></script>

    <script>
        // 全局累加文件列表
        let selectedFiles = [];

        // 取 CSRF
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        const csrftoken = getCookie('csrftoken');

        // 预览（选择文件即解析前 30 行）
        document.getElementById("csv_files").addEventListener("change", (e) => {
            const files = Array.from(e.target.files || []);
            addFiles(files);
            e.target.value = ""; // 允许再次选择相同文件名
        });
        // 追加选择（隐藏 input）
        document.getElementById("btnAddMore").addEventListener("click", () => {
            document.getElementById("csv_files_more").click();
        });
        document.getElementById("csv_files_more").addEventListener("change", (e) => {
            const files = Array.from(e.target.files || []);
            addFiles(files);
            e.target.value = "";
        });

        // 清空所有已选文件
        document.getElementById("btnClearAll").addEventListener("click", () => {
            selectedFiles = [];
            renderCsvPreview(selectedFiles);
        });
        function addFiles(files) {
            const key = f => `${f.name}__${f.size}__${f.lastModified}`;
            const exists = new Set(selectedFiles.map(key));
            const toAdd = files.filter(f => !exists.has(key(f)));
            selectedFiles = selectedFiles.concat(toAdd);
            renderCsvPreview(selectedFiles);
        }



        // 提交上传 -> 渲染雷达图
        document.getElementById("csvUploadForm").addEventListener("submit", function (e) {
            e.preventDefault();
            if (!selectedFiles.length) { alert("请选择至少一个 CSV 文件"); return; }

            const formData = new FormData();
            for (const f of selectedFiles) formData.append("csv_files", f);

            fetch("{% url 'upload_csv' %}", {
                method: "POST",
                headers: { "X-CSRFToken": csrftoken },
                body: formData,
            })
                .then(r => r.json())
                .then(result => {
                    if (result.status === 'ok') {
                        renderRadarChart(result.data);
                    } else {
                        alert("Upload failed: " + (result.msg || 'unknown'));
                    }
                })
                .catch(err => console.error('Error:', err));
        });


        // ========= 核心：渲染单一雷达图 =========
        // ========= 核心：渲染单一雷达图（支持两种比较模式） =========
        function renderRadarChart(data) {
            // === 1) 指标别名表 ===
            const metrics = [
                { name: 'Costs',                        keys: ['Costs','cost','costs'] },
                { name: 'Sequencing Depth Requirement', keys: ['Sequencing Depth Requirement','copy_num','depth','seq_depth'] },
                { name: 'Encoding Runtime',             keys: ['Encoding Runtime','encode_time','encoding_time','Encoding time'] },
                { name: 'Decoding Runtime',             keys: ['Decoding Runtime','decode_time','decoding_time','Decoding time'] },
                { name: 'Physical Ratio',               keys: ['Physical Ratio','physical ratio','physical_ratio','phys_ratio','physical ratio'] },
                { name: 'Logical Ratio',                keys: ['Logical Ratio','logical density','logical_ratio','log_ratio','logical ratio'] },
                { name: 'GC Contents',                  keys: ['GC Contents','GC contents','gc_contents','gc_content','gc'] },
                { name: 'Maximum Homopolymers Length',  keys: ['Maximum Homopolymers Length','Maximum homopolymers length','max_homopolymer','max_homopolymers','max_homopolymer_len'] },
                { name: 'File Recovery',                keys: ['File Recovery','file_recovery','bit_recovery','bits_recovery'] },
            ];
            // === 调整指标顺序：交换位置 ===
            function swapMetric(arr, aName, bName) {
                const i = arr.findIndex(m => m.name === aName);
                const j = arr.findIndex(m => m.name === bName);
                if (i > -1 && j > -1) {
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
            }

// 把 “Maximum Homopolymers Length” ↔ “Costs” 交换
            swapMetric(metrics, 'Maximum Homopolymers Length', 'Costs');

// 把 “Sequencing Depth Requirement” ↔ “Physical Ratio” 交换
            swapMetric(metrics, 'Sequencing Depth Requirement', 'Physical Ratio');

            const UNITS = {
                'Costs': '$', 'Sequencing Depth Requirement': '×',
                'Encoding Runtime': 's', 'Decoding Runtime': 's',
                'Physical Ratio': '%', 'Logical Ratio': '%',
                'GC Contents': '%', 'Maximum Homopolymers Length': 'nt', 'File Recovery': '%'
            };

            // === 2) 小工具 ===
            const getField = (row, ...names) => {
                for (const n of names) {
                    if (row[n] !== undefined && row[n] !== null && row[n] !== '') return row[n];
                }
                return undefined;
            };
            const getStr = (v, fallback='') => String(v == null ? fallback : v);
            function getValue(row, keys) {
                for (const k of keys) {
                    const v = row[k];
                    if (v !== undefined && v !== null && v !== '') {
                        const num = Number(v);
                        if (!Number.isNaN(num)) return num;
                    }
                }
                return null;
            }

            // === 3) 解析方法名 & 文件名 ===
            const methodsAll   = data.map(r => getStr(getField(r, 'Method','method'),'unknown'));
            const filesAll     = data.map(r => getStr(getField(r, 'Filename','filename'),'unknown.csv'));
            const methodsUniq  = [...new Set(methodsAll)];
            const filesUniq    = [...new Set(filesAll)];

            // 约束：要么“同方法多文件”，要么“同文件多方法”
            if (methodsUniq.length > 1 && filesUniq.length > 1) {
                alert('检测到同时存在“多种方法”和“多份文件”。\n请调整选择：\n  · 仅保留一种方法，用于比较不同文件；\n  · 或仅保留一个文件，用于比较不同方法。');
                return;
            }

            let compareBy = 'single'; // 'method' | 'file' | 'single'
            if (methodsUniq.length > 1) compareBy = 'method';     // 同一文件，比较不同方法
            else if (filesUniq.length > 1) compareBy = 'file';    // 同一方法，比较不同文件

            // === 4) 过滤“有效数据集”并构建分组 ===
            let activeRows = data.slice();
            let groups = [];   // [{ name, rows: [...] }]
            let legendLabels = [];
            let titleHint = '';

            if (compareBy === 'method') {
                // 需要确保只有一个文件
                const theFile = filesUniq[0];
                activeRows = data.filter(r => getStr(getField(r,'Filename','filename'),'unknown.csv') === theFile);
                groups = methodsUniq.map(m => ({
                    name: m,
                    rows: activeRows.filter(r => getStr(getField(r,'Method','method'),'unknown') === m)
                }));
                legendLabels = methodsUniq;
                titleHint = `Comparison: Methods (File: ${theFile})`;
            } else if (compareBy === 'file') {
                // 需要确保只有一个方法
                const theMethod = methodsUniq[0];
                activeRows = data.filter(r => getStr(getField(r,'Method','method'),'unknown') === theMethod);
                groups = filesUniq.map(f => ({
                    name: f,
                    rows: activeRows.filter(r => getStr(getField(r,'Filename','filename'),'unknown.csv') === f)
                }));
                legendLabels = filesUniq;
                titleHint = `Comparison: Files (Method: ${theMethod})`;
            } else {
                // 只有一个多边形
                const onlyLabel = methodsUniq[0] || filesUniq[0] || 'single';
                groups = [{ name: onlyLabel, rows: activeRows }];
                legendLabels = [onlyLabel];
                titleHint = `Single Series`;
            }

            // === 5) 针对“有效数据集”计算各指标的 min/max（含 Physical Ratio 的下限抬升） ===
            const PHYS_NAME = 'Physical Ratio';
            const metricMin = {}, metricMax = {};
            metrics.forEach(m => {
                const vals = activeRows
                    .map(r => getValue(r, m.keys))
                    .filter(v => v !== null);
                const mn = vals.length ? Math.min(...vals) : 0;
                const mx = vals.length ? Math.max(...vals) : 1;

                metricMin[m.name] = 0;
                metricMax[m.name] = mx > 0 ? mx * 1.1 : 1;

                if (m.name === PHYS_NAME && vals.length) {
                    const span = mx - mn;
                    const pad  = Math.max(0.002, span * 0.2);
                    metricMin[m.name] = Math.max(0.9, mn - pad);
                    metricMax[m.name] = Math.min(1.05, mx + pad);
                }
            });

            function mapForRadar(metric, raw) {
                const maxv = metricMax[metric.name] ?? 1;
                const minv = metricMin[metric.name] ?? 0;
                if (raw == null || Number.isNaN(raw)) return minv;
                return Math.max(minv, Math.min(raw, maxv)); // 只裁剪到刻度范围，不做归一化/反向
            }

            // === 6) 计算每个分组的均值（原始均值 & 雷达绘图值） ===
            const groupAgg = groups.map(g => {
                const rawAvg = metrics.map(m => {
                    const arr = g.rows.map(r => getValue(r, m.keys)).filter(v => v !== null);
                    return arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : 0;
                });
                const mapped = rawAvg.map((v,i) => mapForRadar(metrics[i], v));
                return { name: g.name, rawAvg, mapped };
            });

            const seriesData = groupAgg.map(x => ({ name: x.name, value: x.mapped }));
            const indicator = metrics.map(m => {
                const unit = UNITS[m.name] || '';
                const label = unit ? `${m.name} (${unit})` : m.name;
                return { name: label, max: metricMax[m.name] || 1, min: metricMin[m.name] ?? 0 };
            });

            // === 7) 渲染 ECharts（含滚轮缩放） ===
            const el = document.getElementById('radarChart');
            const baseHeight = 720;
            el.style.height = baseHeight + 'px';
            const chart = echarts.init(el);

            chart.setOption({
                title: { text: titleHint, left: 'center', top: 8, textStyle: { fontSize: 24, fontWeight: 500 } },
                legend: { data: legendLabels, top: 56,textStyle: { fontSize: 24 } },
                radar: {
                    indicator,
                    center: ['50%', '56%'],
                    radius: '62%',
                    axisName: { color: '#333',fontSize: 20, },
                    splitNumber: 4
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function (params) {
                        const entry = groupAgg.find(x => x.name === params.name);
                        if (!entry) return params.name;
                        const lines = [ `<b>${params.name}</b>` ];
                        for (let i = 0; i < metrics.length; i++) {
                            const m = metrics[i];
                            const raw = entry.rawAvg[i];
                            const mapped = entry.mapped[i];
                            lines.push(`${m.name}：${Number.isFinite(raw) ? raw : 0}  ` +
                                `<span style="opacity:.6"></span>`);
                        }
                        return lines.join('<br/>');
                    }
                },
                {#toolbox: {#}
                {#    right: 10,#}
                {#    feature: {#}
                {#        saveAsImage: { name: 'radar_chart', type: 'png', pixelRatio: 3, backgroundColor: '#fff' },#}
                {#        restore: {}#}
                {#    }#}
                toolbox: {
                    right: 10,
                    feature: {
                        saveAsImage: { name: 'radar_chart', type: 'png', pixelRatio: 10, backgroundColor: '#fff' },
                        restore: {}
                    }
                },

                series: [{ type: 'radar', data: seriesData, areaStyle: { opacity: 0.08 } }]
            });

            let zoom = 1.0, minZoom = 0.7, maxZoom = 2.0;
            el.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = (e.deltaY < 0 ? 0.1 : -0.1);
                zoom = Math.max(minZoom, Math.min(maxZoom, +(zoom + delta).toFixed(2)));
                el.style.height = Math.round(baseHeight * zoom) + 'px';
                chart.resize();
            });
            window.addEventListener('resize', () => chart.resize());
        }

        // ============ CSV 预览（保留你的） ============
        function renderCsvPreview(files) {
            const host = document.getElementById('previewArea');
            host.innerHTML = '';

            if (!files.length) {
                host.innerHTML = '<div class="text-muted">未选择文件。</div>';
                return;
            }

            const tabId = 'csvPreviewTabs_' + Date.now();
            const nav = document.createElement('ul');
            nav.className = 'nav nav-tabs';
            nav.id = tabId;

            const pane = document.createElement('div');
            pane.className = 'tab-content border border-top-0 p-3';

            files.forEach((file, idx) => {
                const tabLinkId = `${tabId}_link_${idx}`;
                const paneId = `${tabId}_pane_${idx}`;

                const li = document.createElement('li');
                li.className = 'nav-item';
                li.innerHTML = `
        <a class="nav-link ${idx===0?'active':''}" id="${tabLinkId}" data-bs-toggle="tab" href="#${paneId}" role="tab">
          ${file.name}
        </a>`;
                nav.appendChild(li);

                const div = document.createElement('div');
                div.className = `tab-pane fade ${idx===0?'show active':''}`;
                div.id = paneId;
                div.role = 'tabpanel';
                div.innerHTML = `<div class="text-muted">Parsing ${file.name} ...</div>`;
                pane.appendChild(div);

                Papa.parse(file, {
                    header: true,
                    preview: 30,
                    skipEmptyLines: 'greedy',
                    complete: (res) => {
                        const fields = res.meta.fields || [];
                        const rows = res.data || [];

                        if (!fields.length) {
                            div.innerHTML = `<div class="text-danger">未检测到表头或文件为空。</div>`;
                            return;
                        }

                        const table = document.createElement('table');
                        table.className = 'table table-sm table-striped table-hover';

                        const thead = document.createElement('thead');
                        thead.innerHTML = `<tr>${fields.map(h=>`<th>${escapeHtml(h)}</th>`).join('')}</tr>`;
                        table.appendChild(thead);

                        const tbody = document.createElement('tbody');
                        rows.forEach(r => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = fields.map(h => `<td>${escapeHtml(r[h])}</td>`).join('');
                            tbody.appendChild(tr);
                        });
                        table.appendChild(tbody);

                        const info = document.createElement('div');
                        info.className = 'small text-muted mb-2';
                        info.textContent = `显示前 ${rows.length} 行；总列数：${fields.length}`;

                        div.innerHTML = '';
                        div.appendChild(info);
                        div.appendChild(table);
                    },
                    error: (err) => {
                        div.innerHTML = `<div class="text-danger">解析失败：${err?.message || err}</div>`;
                    }
                });
            });

            host.appendChild(nav);
            host.appendChild(pane);
        }

        function escapeHtml(v) {
            if (v === null || v === undefined) return '';
            return String(v)
                .replace(/&/g,'&amp;')
                .replace(/</g,'&lt;')
                .replace(/>/g,'&gt;')
                .replace(/"/g,'&quot;')
                .replace(/'/g,'&#039;');
        }
    </script>




{% endblock %}
