{% extends 'layout.html' %}
{% load static %}

{% block link %}
    {#        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">#}

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

{% endblock %}
{% block css %}

    :root {
    --primary-blue: #007bff;
    --primary-blue-hover: #0056b3;
    --text-dark: #212529;
    --text-light: #6c757d;
    --bg-light: #f8f9fa;
    --border-color: #dee2e6;
    }
    .container.my-5 {
    max-width: 80vw;
    width: 100%;

    background-color: #fdfdfd; /* 或者 #f8f9fa，比纯白柔和 */
    padding: 4rem 2rem;
    border-radius: 0.75rem;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
    transition: background-color 0.3s ease;
    }

    body {
    background-color: #fff;
    color: var(--text-dark);
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    .page-title {
    color: var(--primary-blue);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-align: center;
    margin-bottom: 2rem;
    user-select: none;
    }

    .section-title {
    background-color: rgba(0, 123, 255, 0.2); /* 加一点淡蓝底 */
    padding: 0.75rem 1rem;
    border-radius: 0.25rem;
    color: var(--text-dark);
    font-weight: 600;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    user-select: none;
    }


    .section-title .fa {
    color: var(--primary-blue);
    margin-right: 10px;
    }

    .form-label.parameter {
    font-weight: 500;
    font-size: 1.2em;
    color: var(--text-dark); /* 原来是 text-light */
    user-select: none;
    }

    .form-control {

    height: 2.5rem;
    padding: 0.375rem 0.75rem;
    font-size: 1.2rem;
    line-height: 1.5;
    font-family: inherit;
    border-radius: 0.25rem;
    border: 1px solid var(--border-color);
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }







    .form-control:focus {
    border-color: var(--primary-blue);
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
    outline: none;
    }


    .btn-main {
    background-color: var(--primary-blue);
    color: white;
    font-weight: 700;
    border: none;
    padding: 0.5rem 1.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-radius: 0.25rem;
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
    cursor: pointer;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
    }





    /* 进度条默认Bootstrap 4样式即可 */
    .progress-bar {
    background-color: var(--primary-blue);
    transition: width 0.4s ease;
    }

    /* 预览区域等样式保持不变 */


    .preview-area {
    min-height: 100px; /* 初始高度更小 */
    max-height: 400px; /* 预览框最大高度 */
    max-width: 100%;
    background-color: var(--bg-light);
    border: 1px dashed var(--border-color);
    border-radius: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-light);
    font-style: italic;
    overflow-y: auto; /* 内容超出可滚动 */
    padding: 1rem;
    transition: height 0.3s ease;
    user-select: text;
    }

    .preview-area img {
    max-width: 100%;
    max-height: 250px;
    border-radius: 4px;
    object-fit: contain;
    user-select: none;
    }

    .preview-area pre {
    white-space: pre-wrap;
    word-break: break-word;
    color: var(--text-dark);
    max-height: 250px;
    overflow-y: auto;
    font-family: Consolas, Monaco, monospace;
    font-size: 1.2rem;
    user-select: text;
    }

    .btn-main {
    background-color: var(--primary-blue);
    color: white;
    font-weight: 700;
    border: none;
    padding: 0.5rem 1.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-radius: 0.25rem;
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
    cursor: pointer;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
    }

    .btn-main:hover:not(:disabled) {
    background-color: var(--primary-blue-hover);
    box-shadow: 0 6px 16px rgba(0, 123, 255, 0.5);
    color: white;
    }

    .btn-main:disabled {
    background-color: #6c757d;
    color: white;
    cursor: not-allowed;
    box-shadow: none;
    }

    .progress-bar {
    background-color: var(--primary-blue);
    transition: width 0.4s ease;
    }


{% endblock %}

{% block content %}


    <div style="background-color: #f1f3f5; padding: 2rem 0;">

        <div class="container my-5">


            <h1 class="text-center" data-aos="fade-up" style="font-size: 3vw;font-family: Arial;color: #007bff!important;">
                DNA Encoding Module
            </h1>
            <form id="encodeForm" action="{% url 'encode' %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {% if errors %}
                    <div class="alert alert-danger" role="alert">{{ errors }}</div>
                {% endif %}

                <div class="mb-5">
                    <h5 class="section-title mb-3"><i class="fa fa-upload"></i>Input</h5>
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="custom-file">
                                <label for="inputFile" class="form-label parameter custom-file-label" id="fileNameLabel">
                                    {% if input_file_front %}{{ input_file_front }}{% else %}Select file{% endif %}
                                </label>
                                <div class="input-group">

                                    <input type="text" class="custom-file-input" id="filename"
                                           value="{{ base.filename }}" hidden
                                           name="filename">
                                    <input type="file" class="custom-file-input" id="inputFile"
                                           name="file" style="height: 3rem; "
                                    >
                                </div>
                            </div>

{#                            <button type="button" class="btn btn-primary mt-3" id="uploadBtn"#}
{#                                    style="display: none;">Upload to Preview#}
{#                            </button>#}
                            <div id="uploadProgressContainer" class="progress mt-2"
                                 style="height: 10px; display: none;">
                                <div id="uploadProgressBar"
                                     class="progress-bar progress-bar-striped progress-bar-animated"
                                     role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0"
                                     aria-valuemax="100"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label parameter">File Preview</label>

                                <div class="preview-area p-3" id="preview_encode">
                                    <img src="{{ preview_data.file_content }}"  alt="Preview Image" style="max-height: 10vw;">
                                </div>


                        </div>
                    </div>
                </div>

                <div class="mb-5">
                    <h5 class="section-title mb-3"><i class="fa fa-tasks"></i>Encode Method</h5>
                    <div class="p-4 border rounded" style="background-color: #fdfdfd;">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="method" class="form-label parameter">Algorithm</label>
                                <select class="form-control" id="method" name="method"
                                >
                                    <option value="fountain" {% if base.method == "fountain" %}selected{% endif %}>DNA
                                        Fountain
                                    </option>
                                    <option value="YYC" {% if base.method == "YYC" %}selected{% endif %}>Yin-Yang Codec
                                    </option>
                                    <option value="derrick" {% if base.method == "derrick" %}selected{% endif %}>Derrick
                                    </option>
                                    <option value="PolarCode" {% if base.method == "PolarCode" %}selected{% endif %}>DNA
                                        PolarCode
                                    </option>
                                    <option value="hedges" {% if base.method == "hedges" %}selected{% endif %}>Hedges
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-5" id="algorithm-parameters">
                    <h5 class="section-title mb-3"><i class="fa fa-cogs"></i>Algorithm Parameters</h5>
                    <div class="p-4 border rounded" style="background-color: #fdfdfd;">
                        <div class="row g-4">
                            <!-- 通用参数 -->


                            <!-- 共用参数区域,rs和gc,主要是喷泉码和阴阳码-->


                            <!-- 每种算法专属参数区域 -->
                            <div id="redundancy_cop" class="row g-4 col-12" style="display: none;">
                                <div class="col-md-3">
                                    <label for="seq_length_fountain" class="form-label parameter">Segment Length</label>
                                    <input type="number" class="form-control"
                                           id="seq_length_fountain" value="{{ base.seq_length }}" name="seq_length_fountain">
                                </div>
                                <div class="col-md-3">
                                    <label for="homopolymer_fountain" class="form-label parameter">Max Homopolymer</label>
                                    <input type="number" class="form-control"
                                           id="homopolymer_fountain" value="{{ base.homopolymer }}" name="homopolymer_fountain">
                                </div>
                                <div class="col-md-3">
                                    <label for="gc_fountain" class="form-label parameter">GC Bias</label>
                                    <input type="number" class="form-control"
                                           id="gc_fountain" value="{{ base.gc }}" name="gc_fountain">
                                </div>
                                <div class="col-md-3">
                                    <label for="rs_num_fountain" class="form-label parameter">RS Nums (bytes)</label>
                                    <input type="number" class="form-control"
                                           id="rs_num_fountain" value="{{ base.rs_num }}" name="rs_num_fountain">
                                </div>
                                <div class="col-md-3">
                                    <label for="delta_fountain" class="form-label parameter">Delta</label>
                                    <input type="text" class="form-control"
                                           id="delta_fountain" value="{{ base.delta }}" name="delta_fountain">
                                </div>
                                <div class="col-md-3">
                                    <label for="redundancy_rate_fountain" class="form-label parameter">Redundancy</label>
                                    <input type="text" class="form-control"
                                           id="redundancy_rate_fountain" value="{{ base.redundancy_rate }}" name="redundancy_rate_fountain">
                                </div>
                                <div class="col-md-3">
                                    <label for="c_dist_fountain" class="form-label parameter">C_dist</label>
                                    <input type="text" class="form-control"
                                           id="c_dist_fountain" value="{{ base.c_dist }}" name="c_dist_fountain">
                                </div>
                                <div class="col-md-3">
                                    <label for="crc_fountain" class="form-label parameter">CRC Nums (bytes)</label>
                                    <select class="form-control" id="crc_fountain" name="crc_fountain"
                                    >
                                        <option value=0 {% if base.crc == 0 %}selected{% endif %}>0</option>
                                        <option value=2 {% if base.crc == 2 %}selected{% endif %}>2</option>
                                    </select>
                                </div>
                            </div>
                            <div id="yyc_cop" class="row g-4 col-12" style="display: none;">
                                <div class="col-md-3">
                                    <label for="seq_length_yyc" class="form-label parameter">Segment Length</label>
                                    <input type="number" class="form-control"
                                           id="seq_length_yyc" value="{{ base.seq_length }}" name="seq_length_yyc">
                                </div>
                                <div class="col-md-3">
                                    <label for="homopolymer_yyc" class="form-label parameter">Max Homopolymer</label>
                                    <input type="number" class="form-control"
                                           id="homopolymer_yyc" value="{{ base.homopolymer }}" name="homopolymer_yyc">
                                </div>
                                <div class="col-md-3">
                                    <label for="gc_yyc" class="form-label parameter">GC Bias</label>
                                    <input type="number" class="form-control"
                                           id="gc_yyc" value="{{ base.gc }}" name="gc_yyc">
                                </div>
                                <div class="col-md-3">
                                    <label for="rs_num_yyc" class="form-label parameter">RS Nums (bytes)</label>
                                    <input type="number" class="form-control"
                                           id="rs_num_yyc" value="{{ base.rs_num }}" name="rs_num_yyc">
                                </div>
                                <div class="col-md-3">
                                    <label for="max_iterations_yyc" class="form-label parameter">Max Iterations</label>
                                    <input type="number" class="form-control"
                                           id="max_iterations_yyc" value="{{ base.max_iterations }}" name="max_iterations_yyc">
                                </div>
                                <div class="col-md-3">
                                    <label for="crcyyc" class="form-label parameter">CRC Nums (bytes)</label>
                                    <select class="form-control" id="crcyyc" name="crcyyc"
                                    >
                                        <option value=0 {% if base.crc == 0 %}selected{% endif %}>0</option>
                                        <option value=2 {% if base.crc == 2 %}selected{% endif %}>2</option>
                                    </select>
                                </div>
                            </div>
                            <div id="derrick_cop" class="row g-4 col-12" style="display: none;">
                                <div class="col-md-3">
                                    <label for="seq_length_derrick" class="form-label parameter">Segment Length</label>
                                    <input type="number" class="form-control"
                                           id="seq_length_derrick" value="{{ base.seq_length }}" name="seq_length_derrick">
                                </div>
                                <div class="col-md-3">
                                    <label for="homopolymer_derrick" class="form-label parameter">Max Homopolymer</label>
                                    <input type="number" class="form-control"
                                           id="homopolymer_derrick" value="{{ base.homopolymer }}" name="homopolymer_derrick">
                                </div>
                                <div class="col-md-3">
                                    <label for="matrix_n_derrick" class="form-label parameter">matrix_n</label>
                                    <input type="number" class="form-control"
                                           id="matrix_n_derrick" value="{{ base.matrix_n }}" name="matrix_n_derrick">
                                </div>
                                <div class="col-md-3">
                                    <label for="matrix_r_derrick" class="form-label parameter">matrix_r (rs_rows)</label>
                                    <input type="number" class="form-control"
                                           id="matrix_r_derrick" value="{{ base.matrix_r }}" name="matrix_r_derrick">
                                </div>
                            </div>
                            <div id="polar_cop" class="row g-4 col-12" style="display: none;">
                                <div class="col-md-3">
                                    <label for="seq_length_polar" class="form-label parameter">Segment Length</label>
                                    <input type="number" class="form-control"
                                           id="seq_length_polar" value="{{ base.seq_length }}" name="seq_length_polar">
                                </div>
                                <div class="col-md-3">
                                    <label for="homopolymer_polar" class="form-label parameter">Max Homopolymer</label>
                                    <input type="number" class="form-control"
                                           id="homopolymer_polar" value="{{ base.homopolymer }}" name="homopolymer_polar">
                                </div>
                                <div class="col-md-3">
                                    <label for="frozen_bits_len_polar" class="form-label parameter">Frozen Bits Length</label>
                                    <input type="number" class="form-control"
                                           id="frozen_bits_len_polar" value="{{ base.frozen_bits_len }}" name="frozen_bits_len_polar">
                                </div>
                            </div>

                            <div id="hedges_cop" class="row g-4 col-12" style="display: none;">
                                <div class="col-md-3">
                                    <label for="seq_length_hedges" class="form-label parameter">Segment Length</label>
                                    <input type="number" class="form-control"
                                           id="seq_length_hedges" value="{{ base.seq_length }}" name="seq_length_hedges">
                                </div>
                                <div class="col-md-3">
                                    <label for="homopolymer_hedges" class="form-label parameter">Max Homopolymer</label>
                                    <input type="number" class="form-control"
                                           id="homopolymer_hedges" value="{{ base.homopolymer }}" name="homopolymer_hedges">
                                </div>
                                <div class="col-md-3">
                                    <label for="matrix_n_h_hedges" class="form-label parameter">matrix_n</label>
                                    <input type="number" class="form-control"
                                           id="matrix_n_h_hedges" value="{{ base.matrix_n_h }}" name="matrix_n_h_hedges">
                                </div>
                                <div class="col-md-3">
                                    <label for="matrix_r_h_hedges" class="form-label parameter">matrix_r (rs_rows)</label>
                                    <input type="number" class="form-control"
                                           id="matrix_r_h_hedges" value="{{ base.matrix_r_h }}" name="matrix_r_h_hedges">
                                </div>
                                <div class="col-md-3">
                                    <label for="coderatecode_hedges" class="form-label parameter">Coderate Code</label>
                                    <select id="coderatecode_hedges" name="coderatecode_hedges" class="form-control"
                                    >
                                        <option value="1" {% if base.coderatecode == '1' %}selected{% endif %}>0.75</option>
                                        <option value="2" {% if base.coderatecode == '2' %}selected{% endif %}>0.6</option>
                                        <option value="3" {% if base.coderatecode == '3' %}selected{% endif %}>0.5</option>
                                        <option value="4" {% if base.coderatecode == '4' %}selected{% endif %}>1 / 3
                                        </option>
                                        <option value="5" {% if base.coderatecode == '5' %}selected{% endif %}>0.25</option>
                                        <option value="6" {% if base.coderatecode == '6' %}selected{% endif %}>1 / 6
                                        </option>
                                    </select>
                                </div>
                            </div>



                        </div>
                    </div>
                </div>


                <button type="button" id="encodeTriggerBtn" class="btn btn-main">
                    <i class="fa fa-play-circle"></i> Encode File
                </button>
                <button type="submit" id="encodeBtn" name="encodeBtn" class="btn btn-main" style="display: none;">
                    <i class="fa fa-play-circle"></i> Encode File
                </button>
                <a href="?reset=1" id="reencodeBtn" class="btn btn-main" >
                    <i class="fa fa-refresh"></i> Re-encode
                </a>

            </form>
            <!-- Modal -->
            <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="confirmModalLabel">Confirm Encoding Information</h5>
                            <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p><strong>File:</strong> <span id="modalFilename"></span></p>
                            <p><strong>Method:</strong> <span id="modalMethod"></span></p>
                            <p><strong>Parameters:</strong></p>
                            <ul id="modalParams">
                                <!-- Dynamically filled -->
                            </ul>
                        </div>
                        {#                      <div id="loading-container" class="text-center mt-3" style="display: none;">#}
                        {#                        <img src="{% static 'images/loading.gif' %}" alt="Loading..." style="width: 60px;">#}
                        {#                        <p style="font-weight: bold;">Encoding in progress...</p>#}
                        {#                    </div>#}
                        <div id="loading-container" class="text-center mt-3" style="display: none;">
                            <p style="font-weight: bold;">Encoding in progress...</p>
                            <div class="progress" style="height: 20px;">
                                <div id="encodeProgressBar"
                                     class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                                     role="progressbar"
                                     style="width: 0%;"
                                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                    0%
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cancelModalBtn">Cancel</button>
                            <button type="button" id="confirmSubmit" name="confirmSubmit" class="btn btn-primary">Confirm and Submit</button>
                        </div>
                    </div>
                </div>
            </div>

            {% if encoded_data %}
                <div class="mt-5">
                    <hr>
                    <h5 class="section-title mt-5 mb-3"><i class="fa fa-sign-out"></i>Output</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label parameter">Result Information</label>
                            <div class="p-4 border rounded">
                                <h5 class="card-title" style="color: #007bff!important;">Method: {{ base.method }}</h5>
                                <p class="card-text mt-3">
                                <div>total bit：{{ encoded_data.total_bit }}</div>
                                <div>total base：{{ encoded_data.total_base }}</div>
                                <div>encode time：{{ encoded_data.encode_time }}</div>
                                <div>DNA sequence number：{{ encoded_data.seq_num }}</div>
                                <div>Information density：{{ encoded_data.density }} bits/nt</div>
                                {#                                <div>GC：{{ encoded_data.gc }}</div>#}
                                <div>max_homopolymer：{{ encoded_data.max_homopolymer }}</div>
                                </p>
                                <a href="{% url 'download_file' mode='encode' %}" class="download-link">download</a>

                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label parameter">Result Preview(Only first 100 lines shown in
                                preview)</label>
                            <div id="result_encode" class="preview-area p-3">

                                {% if encoded_file_content %}
                                    <pre>{{ encoded_file_content }}</pre>
                                {% else %}
                                    <span class="text-muted">No encoded file content available.</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

        </div>
    </div>




{% endblock %}
{% block script %}
    {#        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>#}
    {#        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>#}
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>

    <script>
        $(document).ready(function () {
            const uploadBtn = $('#uploadBtn');
            const inputFile = $('#inputFile');
            const fileNameLabel = $('#fileNameLabel');
            const previewContainer = $('#preview_encode');
            const progressContainer = $('#uploadProgressContainer');
            const progressBar = $('#uploadProgressBar');

            // 1. When a file is selected
            inputFile.on('change', function (e) {

                previewContainer.html('Preparing upload preview...');
                progressContainer.show();
                fileNameLabel.text(e.target.files[0].name);
                progressBar.width('0%').text('0%');

                // 自动上传逻辑直接执行
                triggerPreviewUpload(e.target.files[0]);

            });

            // 2. When the "Upload to Preview" button is clicked
            function triggerPreviewUpload(file) {
                const formData = new FormData();
                formData.append('file_for_preview', file);

                const uploadUrl = "{% url 'upload_for_preview' %}";
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                const xhr = new XMLHttpRequest();
                xhr.open('POST', uploadUrl, true);
                xhr.setRequestHeader('X-CSRFToken', csrftoken);

                xhr.upload.onprogress = function (e) {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        progressContainer.show();
                        progressBar.width(percentComplete + '%');
                        progressBar.text(Math.round(percentComplete) + '%');
                    }
                };

                xhr.onerror = function () {
                    alert('An error occurred during the upload. Please try again.');
                    progressContainer.hide();
                };

                xhr.onload = function () {
                    progressContainer.hide();
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        if (response.success) {
                            previewContainer.html('');
                            const fileType = response.file_type;
                            const fileContent = response.file_content;

                            const canPreview = fileType.startsWith('image/') || fileType.startsWith('text/') ||
                                fileType.startsWith('audio/') || fileType.startsWith('video/');

                            if (canPreview) {
                                previewContainer.css('height', '300px');
                                if (fileType.startsWith('image/')) {
                                    const img = $('<img>').attr('src', fileContent).addClass('img-fluid');
                                    previewContainer.append(img);
                                } else if (fileType.startsWith('text/')) {
                                    const pre = $('<pre>').text(fileContent);
                                    previewContainer.append(pre);
                                } else if (fileType.startsWith('audio/')) {
                                    const audio = $('<audio controls>')
                                        .append($('<source>').attr('src', fileContent).attr('type', fileType));
                                    previewContainer.append(audio);
                                } else if (fileType.startsWith('video/')) {
                                    const video = $('<video controls style="max-width: 100%; max-height: 280px;">')
                                        .append($('<source>').attr('src', fileContent).attr('type', fileType));
                                    previewContainer.append(video);
                                }
                            } else {
                                previewContainer.text(`'${response.file_name}' is a binary file. No preview available.`);
                            }
                        } else {
                            previewContainer.text('Error: ' + response.error);
                        }
                    } else {
                        previewContainer.text('Server error: Could not process the file.');
                    }
                };

                xhr.send(formData);
            }

            // Your existing dynamic parameter logic
            function toggle_parameters() {
                var selectedOption = $('#method').val();
                $('#gc_rs, #redundancy_cop, #yyc_cop, #derrick_cop, #hedges_cop, #polar_cop').hide();

                if (selectedOption === 'fountain') {
                    $('#gc_rs, #redundancy_cop').show();
                } else if (selectedOption === 'YYC') {
                    $('#gc_rs, #yyc_cop').show();
                } else if (selectedOption === 'derrick') {
                    $('#derrick_cop').show();
                } else if (selectedOption === 'PolarCode') {
                    $('#polar_cop').show();
                    $('#seq_length_polar').val(260).prop('disabled', true);
                    $('#homopolymer_polar').prop('disabled', true);
                } else if (selectedOption === 'hedges') {
                    $('#hedges_cop').show();
                }

                // 如果不是 PolarCode，恢复输入框状态
                if (selectedOption !== 'PolarCode') {
                    $('#seq_length, #homopolymer').prop('disabled', false);
                }
            }

            $('#method').change(toggle_parameters);
            toggle_parameters(); // Initial call
            document.getElementById("encodeTriggerBtn").addEventListener("click", function () {
                // 获取字段值
                const filename = document.getElementById("fileNameLabel").innerText || 'N/A';
                const method = document.getElementById("method").value;

                // 填入 modal 内容
                document.getElementById("modalFilename").textContent = filename;
                document.getElementById("modalMethod").textContent = method;

                // 获取所有可见的参数字段
                const paramsList = document.querySelectorAll('#algorithm-parameters input, #algorithm-parameters select');
                const modalParams = document.getElementById("modalParams");
                modalParams.innerHTML = ""; // 清空旧内容

                paramsList.forEach(param => {
                    // 只显示可见的参数
                    if (param.closest("div[style*='display: none']") === null) {
                        const name = param.previousElementSibling?.innerText || param.name;
                        const value = param.value;
                        const li = document.createElement("li");
                        li.textContent = `${name}: ${value}`;
                        modalParams.appendChild(li);
                    }
                });

                // 打开 Modal（Bootstrap 5）
                const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
                modal.show();
            });
            document.getElementById("confirmSubmit").addEventListener("click", function () {
                const loadingContainer = document.getElementById('loading-container');
                const progressBar = document.getElementById('encodeProgressBar');
                const method = document.getElementById("method").value;
                const methodWeights = {
                    fountain: 1,
                    YYC: 1,
                    derrick: 1,
                    PolarCode: 10,
                    hedges: 4.5
                };
                const methodMultiplier = methodWeights[method] || 1;
                // 获取文件大小（KB）
                const fileInput = document.getElementById("inputFile");
                const fileSizeKB = fileInput.files.length > 0 ? fileInput.files[0].size / 1024 : 200;

                // 基础时长（ms）
                const baseDuration = 700; // 1秒

                // 计算倍数级别（指数形式）
                let level = Math.max(0, Math.ceil(Math.log2(fileSizeKB / 100)));
                const totalDuration = baseDuration * Math.pow(2, level) * methodMultiplier;

                // 模拟进度条动画
                const intervalMs = 100;
                const steps = Math.floor(totalDuration / intervalMs);
                let progress = 0;
                let currentStep = 0;

                // 显示 loading
                loadingContainer.style.display = 'block';
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';

                const intervalId = setInterval(() => {
                    if (currentStep < steps) {
                        currentStep++;
                        progress = Math.min(95, Math.floor((currentStep / steps) * 100));
                        progressBar.style.width = progress + '%';
                        progressBar.setAttribute('aria-valuenow', progress);
                        progressBar.textContent = progress + '%';
                    } else {
                        clearInterval(intervalId);
                    }
                }, intervalMs);

                // 提交表单
                document.getElementById("encodeBtn").click();
            });
            {% if disable %}

                const elements = document.querySelectorAll("input, select, textarea, button");
                elements.forEach(el => {
                    el.disabled = true;
                    el.style.backgroundColor = '#e9ecef';
                    el.style.color = '#6c757d';
                    el.style.cursor = 'not-allowed';

                });
            {% endif %}
        });

    </script>



{% endblock %}