{% extends 'layout.html' %}
{% load static %}

{% block link %}
    {#        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">#}
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

{% endblock %}
{% block css %}

    :root {
    --primary-blue: #007bff;
    --primary-blue-hover: #0056b3;
    --text-dark: #212529;
    --text-light: #6c757d;
    --bg-light: #f8f9fa;
    --border-color: #dee2e6;
    }

    body {
    background-color: #fff;
    color: var(--text-dark);
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    .page-title {
    color: var(--primary-blue);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-align: center;
    margin-bottom: 2rem;
    user-select: none;
    }

    .section-title {
    color: var(--text-dark);
    font-weight: 600;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    user-select: none;
    }

    .section-title .fa {
    color: var(--primary-blue);
    margin-right: 10px;
    }

    .form-label.parameter {
    font-weight: 500;
    font-size: 1.2em;
    color: var(--text-dark); /* 原来是 text-light */
    user-select: none;
    }

    .form-control {

    height: 2.5rem;
    padding: 0.375rem 0.75rem;
    font-size: 1.2rem;
    line-height: 1.5;
    font-family: inherit;
    border-radius: 0.25rem;
    border: 1px solid var(--border-color);
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }







    .form-control:focus {
    border-color: var(--primary-blue);
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
    outline: none;
    }


    .btn-main {
    background-color: var(--primary-blue);
    color: white;
    font-weight: 700;
    border: none;
    padding: 0.5rem 1.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-radius: 0.25rem;
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
    cursor: pointer;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
    }

    .btn-main:hover:not(:disabled) {
    background-color: var(--primary-blue-hover);
    box-shadow: 0 6px 16px rgba(0, 123, 255, 0.5);
    color: white;
    }

    .btn-main:disabled {
    background-color: #6c757d;
    color: white;
    cursor: not-allowed;
    box-shadow: none;
    }

    /* 进度条默认Bootstrap 4样式即可 */
    .progress-bar {
    background-color: var(--primary-blue);
    transition: width 0.4s ease;
    }

    /* 预览区域等样式保持不变 */


    .preview-area {
    min-height: 100px; /* 初始高度更小 */
    max-height: 400px; /* 预览框最大高度 */
    max-width: 100%;
    background-color: var(--bg-light);
    border: 1px dashed var(--border-color);
    border-radius: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-light);
    font-style: italic;
    overflow-y: auto; /* 内容超出可滚动 */
    padding: 1rem;
    transition: height 0.3s ease;
    user-select: text;
    }

    .preview-area img {
    max-width: 100%;
    max-height: 250px;
    border-radius: 4px;
    object-fit: contain;
    user-select: none;
    }

    .preview-area pre {
    white-space: pre-wrap;
    word-break: break-word;
    color: var(--text-dark);
    max-height: 250px;
    overflow-y: auto;
    font-family: Consolas, Monaco, monospace;
    font-size: 1.2rem;
    user-select: text;
    }

    .btn-main {
    background-color: var(--primary-blue);
    color: white;
    font-weight: 700;
    border: none;
    padding: 0.5rem 1.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-radius: 0.25rem;
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
    cursor: pointer;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
    }

    .btn-main:hover:not(:disabled) {
    background-color: var(--primary-blue-hover);
    box-shadow: 0 6px 16px rgba(0, 123, 255, 0.5);
    color: white;
    }

    .btn-main:disabled {
    background-color: #6c757d;
    color: white;
    cursor: not-allowed;
    box-shadow: none;
    }

    .progress-bar {
    background-color: var(--primary-blue);
    transition: width 0.4s ease;
    }


{% endblock %}

{% block content %}




    <div class="container my-5">


        <h1 class="text-center" data-aos="fade-up" style="font-size: 3vw;font-family: Arial;color: #007bff!important;">
            DNA Encoding Module
        </h1>
        <form id="encodeForm" action="{% url 'encode' %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {% if errors %}
                <div class="alert alert-danger" role="alert">{{ errors }}</div>
            {% endif %}

            <div class="mb-5">
                <h5 class="section-title mb-3"><i class="fa fa-upload"></i>Input</h5>
                <div class="row align-items-center">
                    <div class="col-md-6">
                            <div class="custom-file">
                                <label for="inputFile" class="form-label parameter custom-file-label "
                                       id="fileNameLabel">Select file</label>
                                <div class="input-group">

                                    <input type="text" class="custom-file-input" id="filename"
                                           value="{{ base.filename }}" hidden
                                           name="filename">
                                    <input type="file" class="custom-file-input" id="inputFile"
                                           name="file" style="height: 3rem; "
                                    >
                                </div>
                            </div>

                            <button type="button" class="btn btn-primary mt-3" id="uploadBtn"
                                    style="display: none;">Upload to Preview
                            </button>
                            <div id="uploadProgressContainer" class="progress mt-2"
                                 style="height: 10px; display: none;">
                                <div id="uploadProgressBar"
                                     class="progress-bar progress-bar-striped progress-bar-animated"
                                     role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0"
                                     aria-valuemax="100"></div>
                            </div>
                        </div>
                    <div class="col-md-6">
                        <label class="form-label parameter">File Preview</label>
                        <div id="preview_encode" class="preview-area p-3">
                            Select a file and click "Upload to Preview"
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-5">
                <h5 class="section-title mb-3"><i class="fa fa-tasks"></i>Encode Method</h5>
                <div class="p-4 border rounded" style="background-color: #fdfdfd;">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="method" class="form-label parameter">Algorithm</label>
                            <select class="form-control" id="method" name="method"
                            >
                                <option value="fountain" {% if base.method == "fountain" %}selected{% endif %}>DNA
                                    Fountain
                                </option>
                                <option value="YYC" {% if base.method == "YYC" %}selected{% endif %}>Yin-Yang Codec
                                </option>
                                <option value="derrick" {% if base.method == "derrick" %}selected{% endif %}>Derrick
                                </option>
                                <option value="PolarCode" {% if base.method == "PolarCode" %}selected{% endif %}>DNA
                                    PolarCode
                                </option>
                                <option value="hedges" {% if base.method == "hedges" %}selected{% endif %}>Hedges
                                </option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-5" id="algorithm-parameters">
                <h5 class="section-title mb-3"><i class="fa fa-cogs"></i>Algorithm Parameters</h5>
                <div class="p-4 border rounded" style="background-color: #fdfdfd;">
                    <div class="row g-4">
                        <!-- 通用参数 -->


                        <!-- 共用参数区域,rs和gc,主要是喷泉码和阴阳码-->


                        <!-- 每种算法专属参数区域 -->
                        <div id="redundancy_cop" class="row g-4 col-12" style="display: none;">
                            <div class="col-md-3">
                                <label for="seq_length" class="form-label parameter">Segment Length</label>
                                <input type="number" class="form-control"
                                       id="seq_length" value="{{ base.seq_length }}" name="seq_length">
                            </div>
                            <div class="col-md-3">
                                <label for="homopolymer" class="form-label parameter">Max Homopolymer</label>
                                <input type="number" class="form-control"
                                       id="homopolymer" value="{{ base.homopolymer }}" name="homopolymer">
                            </div>
                            <div class="col-md-3">
                                <label for="gc" class="form-label parameter">GC Bias</label>
                                <input type="number" class="form-control"
                                       id="gc" value="{{ base.gc }}" name="gc">
                            </div>
                            <div class="col-md-3">
                                <label for="rs_num" class="form-label parameter">RS Nums (bytes)</label>
                                <input type="number" class="form-control"
                                       id="rs_num" value="{{ base.rs_num }}" name="rs_num">
                            </div>
                            <div class="col-md-3">
                                <label for="delta" class="form-label parameter">Delta</label>
                                <input type="text" class="form-control"
                                       id="delta" value="{{ base.delta }}" name="delta">
                            </div>
                            <div class="col-md-3">
                                <label for="redundancy_rate" class="form-label parameter">Redundancy</label>
                                <input type="text" class="form-control"
                                       id="redundancy_rate" value="{{ base.redundancy_rate }}" name="redundancy_rate">
                            </div>
                            <div class="col-md-3">
                                <label for="c_dist" class="form-label parameter">C_dist</label>
                                <input type="text" class="form-control"
                                       id="c_dist" value="{{ base.c_dist }}" name="c_dist">
                            </div>
                            <div class="col-md-3">
                                <label for="crc" class="form-label parameter">CRC Nums (bytes)</label>
                                <select class="form-control" id="crc" name="crc"
                                >
                                    <option value=0 {% if base.crc == 0 %}selected{% endif %}>0</option>
                                    <option value=2 {% if base.crc == 2 %}selected{% endif %}>2</option>
                                </select>
                            </div>
                        </div>
                        <div id="yyc_cop" class="row g-4 col-12" style="display: none;">
                            <div class="col-md-3">
                                <label for="seq_length" class="form-label parameter">Segment Length</label>
                                <input type="number" class="form-control"
                                       id="seq_length" value="{{ base.seq_length }}" name="seq_length">
                            </div>
                            <div class="col-md-3">
                                <label for="homopolymer" class="form-label parameter">Max Homopolymer</label>
                                <input type="number" class="form-control"
                                       id="homopolymer" value="{{ base.homopolymer }}" name="homopolymer">
                            </div>
                            <div class="col-md-3">
                                <label for="gc" class="form-label parameter">GC Bias</label>
                                <input type="number" class="form-control"
                                       id="gc" value="{{ base.gc }}" name="gc">
                            </div>
                            <div class="col-md-3">
                                <label for="rs_num" class="form-label parameter">RS Nums (bytes)</label>
                                <input type="number" class="form-control"
                                       id="rs_num" value="{{ base.rs_num }}" name="rs_num">
                            </div>
                            <div class="col-md-3">
                                <label for="max_iterations" class="form-label parameter">Max Iterations</label>
                                <input type="number" class="form-control"
                                       id="max_iterations" value="{{ base.max_iterations }}" name="max_iterations">
                            </div>
                            <div class="col-md-3">
                                <label for="crcyyc" class="form-label parameter">CRC Nums (bytes)</label>
                                <select class="form-control" id="crcyyc" name="crcyyc"
                                >
                                    <option value=0 {% if base.crc == 0 %}selected{% endif %}>0</option>
                                    <option value=2 {% if base.crc == 2 %}selected{% endif %}>2</option>
                                </select>
                            </div>
                        </div>
                        <div id="derrick_cop" class="row g-4 col-12" style="display: none;">
                            <div class="col-md-3">
                                <label for="seq_length" class="form-label parameter">Segment Length</label>
                                <input type="number" class="form-control"
                                       id="seq_length" value="{{ base.seq_length }}" name="seq_length">
                            </div>
                            <div class="col-md-3">
                                <label for="homopolymer" class="form-label parameter">Max Homopolymer</label>
                                <input type="number" class="form-control"
                                       id="homopolymer" value="{{ base.homopolymer }}" name="homopolymer">
                            </div>
                            <div class="col-md-3">
                                <label for="matrix_n" class="form-label parameter">matrix_n</label>
                                <input type="number" class="form-control"
                                       id="matrix_n" value="{{ base.matrix_n }}" name="matrix_n">
                            </div>
                            <div class="col-md-3">
                                <label for="matrix_r" class="form-label parameter">matrix_r (rs_rows)</label>
                                <input type="number" class="form-control"
                                       id="matrix_r" value="{{ base.matrix_r }}" name="matrix_r">
                            </div>
                        </div>
                        <div id="polar_cop" class="row g-4 col-12" style="display: none;">
                            <div class="col-md-3">
                                <label for="seq_length" class="form-label parameter">Segment Length</label>
                                <input type="number" class="form-control"
                                       id="seq_length" value="{{ base.seq_length }}" name="seq_length">
                            </div>
                            <div class="col-md-3">
                                <label for="homopolymer" class="form-label parameter">Max Homopolymer</label>
                                <input type="number" class="form-control"
                                       id="homopolymer" value="{{ base.homopolymer }}" name="homopolymer">
                            </div>
                            <div class="col-md-3">
                                <label for="frozen_bits_len" class="form-label parameter">Frozen Bits Length</label>
                                <input type="number" class="form-control"
                                       id="frozen_bits_len" value="{{ base.frozen_bits_len }}" name="frozen_bits_len">
                            </div>
                        </div>

                        <div id="hedges_cop" class="row g-4 col-12" style="display: none;">
                            <div class="col-md-3">
                                <label for="seq_length" class="form-label parameter">Segment Length</label>
                                <input type="number" class="form-control"
                                       id="seq_length" value="{{ base.seq_length }}" name="seq_length">
                            </div>
                            <div class="col-md-3">
                                <label for="homopolymer" class="form-label parameter">Max Homopolymer</label>
                                <input type="number" class="form-control"
                                       id="homopolymer" value="{{ base.homopolymer }}" name="homopolymer">
                            </div>
                            <div class="col-md-3">
                                <label for="matrix_n_h" class="form-label parameter">matrix_n</label>
                                <input type="number" class="form-control"
                                       id="matrix_n_h" value="{{ base.matrix_n_h }}" name="matrix_n_h">
                            </div>
                            <div class="col-md-3">
                                <label for="matrix_r_h" class="form-label parameter">matrix_r (rs_rows)</label>
                                <input type="number" class="form-control"
                                       id="matrix_r_h" value="{{ base.matrix_r_h }}" name="matrix_r_h">
                            </div>
                            <div class="col-md-3">
                                <label for="coderatecode" class="form-label parameter">Coderate Code</label>
                                <select id="coderatecode" name="coderatecode" class="form-control"
                                >
                                    <option value="1" {% if base.coderatecode == '1' %}selected{% endif %}>0.75</option>
                                    <option value="2" {% if base.coderatecode == '2' %}selected{% endif %}>0.6</option>
                                    <option value="3" {% if base.coderatecode == '3' %}selected{% endif %}>0.5</option>
                                    <option value="4" {% if base.coderatecode == '4' %}selected{% endif %}>1 / 3
                                    </option>
                                    <option value="5" {% if base.coderatecode == '5' %}selected{% endif %}>0.25</option>
                                    <option value="6" {% if base.coderatecode == '6' %}selected{% endif %}>1 / 6
                                    </option>
                                </select>
                            </div>
                        </div>


                        <!-- 其他参数区域（YYC, derrick, polar, hedges）如你原来已有的可继续添加 -->
                    </div>
                </div>
            </div>


            <button type="submit" id="encodeBtn" name="encodeBtn" class="btn btn-main">
                <i class="fa fa-play-circle"></i> Encode File
            </button>
        </form>

        {% if encoded_data %}
            <div class="mt-5">
                <hr>
                <h5 class="section-title mt-5 mb-3"><i class="fa fa-sign-out"></i>Output</h5>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label parameter">Result Information</label>
                        <div class="p-4 border rounded">
                            <h5 class="card-title" style="color: #007bff!important;">Method: {{ base.method }}</h5>
                            <p class="card-text mt-3">
                            <div>total bit：{{ encoded_data.total_bit }}</div>
                            <div>total base：{{ encoded_data.total_base }}</div>
                            <div>encode time：{{ encoded_data.encode_time }}</div>
                            <div>DNA sequence number：{{ encoded_data.seq_num }}</div>
                            <div>Information density：{{ encoded_data.density }} bits/nt</div>
                            {#                                <div>GC：{{ encoded_data.gc }}</div>#}
                            <div>max_homopolymer：{{ encoded_data.max_homopolymer }}</div>
                            </p>
                            <a href="{% url 'download_file' mode='encode' %}" class="download-link">download</a>

                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label parameter">Result Preview(Only first 500 lines shown in
                            preview)</label>
                        <div id="result_encode" class="preview-area p-3">

                            {% if encoded_file_content %}
                                <pre>{{ encoded_file_content }}</pre>
                            {% else %}
                                <span class="text-muted">No encoded file content available.</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

    </div>

    {% block script %}
        {#        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>#}
        {#        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>#}
        <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
        <script src="{% static 'js/jquery.min.js' %}"></script>
        <script>
            $(document).ready(function () {
                const uploadBtn = $('#uploadBtn');
                const inputFile = $('#inputFile');
                const fileNameLabel = $('#fileNameLabel');
                const previewContainer = $('#preview_encode');
                const progressContainer = $('#uploadProgressContainer');
                const progressBar = $('#uploadProgressBar');

                // 1. When a file is selected
                inputFile.on('change', function (e) {
                    if (e.target.files.length > 0) {
                        uploadBtn.show();
                        previewContainer.html('File selected: ' + e.target.files[0].name + '. Click "Upload to Preview".');
                        progressContainer.hide();
                        fileNameLabel.text(e.target.files[0].name)
                        progressBar.width('0%').text('0%');
                    } else {
                        uploadBtn.hide();
                    }
                });

                // 2. When the "Upload to Preview" button is clicked
                uploadBtn.on('click', function () {
                    const file = inputFile[0].files[0];
                    if (!file) {
                        alert("Please select a file first.");
                        return;
                    }

                    const formData = new FormData();
                    formData.append('file_for_preview', file);

                    // This is the new URL on your server you need to create
                    const uploadUrl = "{% url 'upload_for_preview' %}";
                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    const xhr = new XMLHttpRequest();

                    // 3. Setup AJAX request and event listeners
                    xhr.open('POST', uploadUrl, true);
                    xhr.setRequestHeader('X-CSRFToken', csrftoken);

                    // Progress event
                    xhr.upload.onprogress = function (e) {
                        if (e.lengthComputable) {
                            const percentComplete = (e.loaded / e.total) * 100;
                            progressContainer.show();
                            progressBar.width(percentComplete + '%');
                            progressBar.text(Math.round(percentComplete) + '%');
                        }
                    };

                    // Error event
                    xhr.onerror = function () {
                        alert('An error occurred during the upload. Please try again.');
                        progressContainer.hide();
                    };

                    // Success event
                    xhr.onload = function () {
                        progressContainer.hide();
                        if (xhr.status === 200) {
                            const response = JSON.parse(xhr.responseText);
                            if (response.success) {
                                previewContainer.html(''); // 清空内容

                                // 判断是否支持预览（图片或文本）
                                const canPreview = response.file_type.startsWith('image/') || response.file_type.startsWith('text/');

                                if (canPreview) {
                                    // 只有支持预览，才调整高度
                                    // 这里用之前根据文件大小调整高度的逻辑，或者你自定义的逻辑
                                    {#let newHeight = 100 + Math.min(file.size / 1000, 300);#}
                                    {#newHeight = Math.min(newHeight, 400);#}
                                    {#previewContainer.css('height', newHeight + 'px');#}
                                    previewContainer.css('height', '300px');
                                    if (response.file_type.startsWith('image/')) {
                                        const img = $('<img>').attr('src', response.file_content).addClass('img-fluid');
                                        previewContainer.append(img);
                                    } else {
                                        const pre = $('<pre>').text(response.file_content);
                                        previewContainer.append(pre);
                                    }
                                } else {
                                    // 不支持预览的文件，显示提示，且不调整高度
                                    previewContainer.text(`'${response.file_name}' is a binary file. No preview available.`);
                                    // 不修改 previewContainer 的高度
                                }
                            } else {
                                previewContainer.text('Error: ' + response.error);
                                // 出错时也保持高度不变
                            }
                        } else {
                            previewContainer.text('Server error: Could not process the file.');
                            // 服务器错误也不改高度
                        }
                    };

                    xhr.send(formData);
                });

                // Your existing dynamic parameter logic
                function toggle_parameters() {
                    var selectedOption = $('#method').val();
                    $('#gc_rs, #redundancy_cop, #yyc_cop, #derrick_cop, #hedges_cop, #polar_cop').hide();

                    if (selectedOption === 'fountain') {
                        $('#gc_rs, #redundancy_cop').show();
                    } else if (selectedOption === 'YYC') {
                        $('#gc_rs, #yyc_cop').show();
                    } else if (selectedOption === 'derrick') {
                        $('#derrick_cop').show();
                    } else if (selectedOption === 'PolarCode') {
                        $('#polar_cop').show();
                        $('#seq_length').val(260).prop('disabled', true);
                        $('#homopolymer').val(4).prop('disabled', true);
                    } else if (selectedOption === 'hedges') {
                        $('#hedges_cop').show();
                    }

                    // 如果不是 PolarCode，恢复输入框状态
                    if (selectedOption !== 'PolarCode') {
                        $('#seq_length, #homopolymer').prop('disabled', false);
                    }
                }

                $('#method').change(toggle_parameters);
                toggle_parameters(); // Initial call

            });
        </script>
    {% endblock %}



{% endblock %}